stage("Deploy to EKS") {
    steps {
        script {
            dir('projects/deployK8Application/kubernetes') {
                sh '''
                    # Ensure AWS CLI v2 is first
                    export PATH=/usr/local/bin:$PATH

                    echo "=== Checking tool versions ==="
                    aws --version
                    kubectl version --client

                    echo "=== Configuring kubeconfig to ${KUBECONFIG} ==="
                    aws eks update-kubeconfig \
                        --name jenkins-eks-cluster \
                        --region $AWS_DEFAULT_REGION \
                        --kubeconfig $KUBECONFIG

                    echo "=== Verifying kubeconfig exec apiVersion ==="
                    grep -A5 "exec:" $KUBECONFIG

                    echo "=== Deploying Nginx ==="
                    kubectl apply -f nginx-deployment.yaml

                    kubectl delete service nginx --ignore-not-found
                    kubectl apply -f nginx-service.yaml

                    echo "=== Done. LB will be ready in 2-5 minutes ==="
                '''
            }
        }
    }
}